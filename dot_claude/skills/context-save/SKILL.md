---
name: context-save
description: プロジェクトの作業状態を保存し、次回セッションで復帰可能にする。セッション終了時や作業の区切りで使う。
argument-hint: [project-id]
allowed-tools: Read, Write, Edit, Glob, Bash(git *), Bash(echo *), Bash(mkdir *), Bash(basename *), Bash(date *), Bash(ls *)
---

<!-- NOTE: disable-model-invocation は意図的に設定していない。
     SessionEnd フックによる自動呼び出しに対応するため。 -->

# コンテキスト保存

現在のプロジェクトの作業状態を保存し、次回セッションで復帰できるようにする。

## 書き出し先

`~/.claude/context/{project-id}.md`（上書き保存）

※ 書き出し時は `$HOME/.claude/context/` を使うこと。ディレクトリが存在しなければ `mkdir -p` で作成すること。

## プロジェクトの選択

### 引数あり

`$ARGUMENTS` で指定された値をプロジェクト識別子として使う。
以下の順で部分一致検索する：

1. `~/CLAUDE.local.md` のプロジェクト一覧テーブルのプロジェクト名
2. `~/.claude/context/` 内の既存ファイル名

一意に特定できればそのまま使う。複数マッチした場合は候補を AskUserQuestion で提示する。
該当なしの場合は新規プロジェクトとして作成する。

### 引数なし（手動実行）

以下の優先順でプロジェクトを決定する：

1. **セッション中に `/context-load` で読み込んだプロジェクトがある場合** → そのプロジェクトをデフォルトとして提示（会話履歴から判断する）
2. git リポジトリ内の場合 → リポジトリ名を推奨として提示
3. 上記いずれでもない場合 → `~/CLAUDE.local.md` のプロジェクト一覧テーブルを AskUserQuestion で提示（テーブルが存在しない場合は `~/.claude/context/` 一覧にフォールバック）

いずれの場合も、別のプロジェクトを選べるよう一覧も選択肢に含める（新規作成も選べる）。
新規作成が選ばれた場合 → プロジェクト名を通常のメッセージで聞く。

### 引数なし（自動保存）

SessionEnd フックのリマインダー経由で呼ばれた場合。
**判別方法**: 会話履歴にフックのリマインダーテキスト（`/context-save` の実行を促す内容）が直前にある場合は自動保存と判断する。ユーザーが明示的に `/context-save` を実行した場合は手動実行。

対話できないため、以下の優先順で自動決定する：

1. **セッション中に `/context-load` で読み込んだプロジェクトがある場合** → そのプロジェクトに保存
2. git リポジトリ内 → リポジトリ名で自動保存
3. 上記いずれでもない → 保存をスキップ（「プロジェクトを特定できないため保存をスキップしました」と通知）

## 保存内容

`./template.md` のフォーマットに従って書き出すこと。

### 情報の収集

以下の情報を収集してテンプレートに埋める：

- **git リモート URL**: `git remote get-url origin`（取得できない場合は空欄）
- **現在のブランチ**: `git branch --show-current`
- **git 状態**: `git status --short` の要約
- **直近のコミット**: `git log --oneline -5`
- **プロジェクト概要**: セッション中の作業内容から簡潔にまとめる
- **進行中の作業**: 現在取り組んでいるタスクや未完了の作業
- **判断メモ**: セッション中に行った重要な判断とその理由
- **次のステップ**: 次回セッションで着手すべきこと
- **重要ファイル**: 作業に関連する主要ファイル（プロジェクトルートからの相対パス）

### 既存ファイルの扱い

書き出し先に既存ファイルがある場合：
- まず既存ファイルを読み込む
- `## プロジェクト概要` は既存の内容を引き継ぎつつ、必要なら更新
- それ以外のセクション（ブランチ・状態、進行中の作業など）は最新情報で上書き
- `updated` の日時を更新する

## 自動保存のルール

SessionEnd フックのリマインダーで呼ばれた場合は「引数なし（自動保存）」のフローに従う：

- git リポジトリ内 → リポジトリ名で自動保存
- git リポジトリ外 → 保存をスキップ
- 保存したら「コンテキストを保存しました: {project-id}」とユーザーに通知する
- 保存すべき内容がなければ何もしない

## 注意事項

- パスはプロジェクトルートからの相対パスで記録する（マシン非依存）
- git リモート URL を frontmatter に記録する（マシン間でのプロジェクト同定用）
- セッション全体を振り返ってからまとめること
