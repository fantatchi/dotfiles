---
name: workspace-init
description: 任意のディレクトリをClaude Codeのワークスペースとして初期化する。プロジェクトのリンクや直接配置を登録し、CLAUDE.local.mdを生成する。
disable-model-invocation: true
allowed-tools: Read, Write, Edit, Bash(ln *), Bash(cmd *), Bash(uname *), Bash(readlink *), Bash(ls *), Bash(mkdir *), Bash(test *), Bash(printenv *)
---

# ワークスペース初期化

現在のディレクトリ（`$CWD`）をClaude Codeのワークスペースとして初期化する。

## 動作フロー

### 1. プラットフォーム判定

`uname -s` の結果で分岐する：

- `Linux` → WSL/Linux
  - シンボリックリンク: `ln -s <target> <linkname>`
- それ以外（`uname` がない / `MINGW` / `MSYS` / `CYGWIN`）→ Windows
  - ジャンクション: `cmd /c mklink /J <linkname> <target>`（管理者権限不要）

### 2. 既存状態の確認

`CLAUDE.local.md` が既に存在する場合：
- 既存のプロジェクト一覧テーブルをパースして読み込む
- 「既存プロジェクトが見つかりました」と一覧を表示
- 追加・削除の選択肢を提示

### 3. プロジェクト登録（対話形式）

以下を繰り返す。**選択式の質問には AskUserQuestion を使い、自由入力（パス・説明など）は通常のメッセージで聞く。**

1. **操作選択**（AskUserQuestion）：
   - **プロジェクトを追加**
   - **プロジェクトを削除**（既存がある場合のみ）
   - **完了**（登録終了）

2. 追加の場合、**方式選択**（AskUserQuestion）：
   - **リンク** — 外部ディレクトリへのシンボリックリンク（またはジャンクション）を作成
   - **直接配置** — workspace 直下に既にあるディレクトリを登録（リンク作成なし）

3. 方式に応じて質問する：

   **リンクの場合:**
   - **プロジェクトパス** — 通常のメッセージで絶対パスを聞く
   - プロジェクト名（= リンク名）はパスの basename を自動採用。変更したい場合のみ聞く
   - **説明** — 通常のメッセージで聞く（任意、スキップ可）

   **直接配置の場合:**
   - workspace 直下の未登録ディレクトリを `ls` で取得し、AskUserQuestion の選択肢として提示
   - **説明** — 通常のメッセージで聞く（任意、スキップ可）
   - ※ 指定されたディレクトリが workspace 直下に存在しない場合はエラー

4. **削除**の場合、既存一覧を AskUserQuestion の選択肢として提示

### 4. プロジェクト配置

**リンク方式:**
- シンボリックリンク（WSL/Linux）またはジャンクション（Windows）を作成
- 既にリンクが存在し、同じターゲットを指している場合はスキップ
- 既にリンクが存在し、異なるターゲットを指している場合は警告して確認

**直接配置:**
- 既に存在するディレクトリを CLAUDE.local.md に登録するだけ。ファイル操作は行わない

**削除されたプロジェクト:**
- リンク・フォルダは削除しない（手動削除を案内する）
- CLAUDE.local.md の一覧からのみ除外

### 5. CLAUDE.local.md 生成

以下の内容で `CLAUDE.local.md` を生成（既存がある場合は上書き）：

```markdown
# ワークスペース

このディレクトリはClaude Code のワークスペースとして機能する。
プロジェクトはリンクまたは直接配置で構成されている。

## プロジェクト一覧

| プロジェクト | 方式 | リンク先 | 説明 |
|---|---|---|---|
| {name} | link | /path/to/project | 説明 |
| {name} | direct | — | 説明 |
| ... | ... | ... | ... |

## 使い方

### プロジェクトで作業を始める

各プロジェクトのディレクトリで直接 `claude` を起動する。

\`\`\`bash
cd ./{project-name}
claude
\`\`\`

### 前回の作業を再開する

セッション開始後に `/context-load` を実行すると、前回のコンテキスト（ブランチ、進行中の作業、次のステップなど）が復帰される。
プロジェクトは git リポジトリ名から自動判定される。

### 作業を保存する

セッション終了時に `/context-save` を実行すると、現在の作業状態が Obsidian Vault に保存される。
セッション終了時のフックでもリマインダーが表示される。

### ナレッジを検索する

`/knowledge-search <キーワード>` で過去のログやリソースを横断検索できる。

### プロジェクトを追加・変更する

このディレクトリで `/workspace-init` を再実行する。
```

### 6. 初期コンテキストの作成

登録した各プロジェクトについて、`$OBSIDIAN_VAULT/_ClaudeContext/{project-name}.md` に初期コンテキストを作成する。

- 既にコンテキストファイルがあるプロジェクトはスキップ（上書きしない）
- `printenv OBSIDIAN_VAULT` で実パスを取得。未設定ならこのステップをスキップ
- ディレクトリが存在しなければ `mkdir -p` で作成
- 内容は context-save の `template.md` に準拠し、最低限の情報（プロジェクト名、説明、git 情報があれば取得）を埋める

### 7. 使い方の案内

CLAUDE.local.md 生成後、ユーザーに使い方を説明する。CLAUDE.local.md の「使い方」セクションの内容を要約して伝える。

## パス形式

プラットフォームに応じたネイティブパスを使用する：
- WSL/Linux: `/home/user/projects/xxx` や `/mnt/c/...`
- Windows: `C:\Users\user\projects\xxx`

ユーザーが入力したパスをそのまま使う。変換は行わない。

## 注意事項

- ワークスペースディレクトリ自体は作成しない（ユーザーが選んだ既存ディレクトリを使う）
- `CLAUDE.local.md` は `.gitignore` に含まれることが多いローカル設定ファイル
- リンク方式でプロジェクトパスが存在しない場合は警告するが、リンク作成は続行する（リモートマウントなど後から利用可能になるケース）
- 直接配置では workspace 直下にディレクトリが存在することを確認する
